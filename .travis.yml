language: node_js
cache:
  directories:
    - .yarn-cache
    - node_modules

before_script:
  - set -e
  - yarn install --frozen-lockfile --cache-folder .yarn-cache
  - export UPDATES_JSON=$(mktemp)
  - export OPTIMIZED_MEDIA_DIR=$(mktemp -d)
script:
  - yarn test
  - ./generate-json > $UPDATES_JSON
  - ./optimize-media $OPTIMIZED_MEDIA_DIR
  - curl -sL scripts.piet.me/ci/setup-git | bash
  - git checkout --force gh-pages
  - cp -v $UPDATES_JSON updates.json
  - rm -vr media/
  - cp -vr $OPTIMIZED_MEDIA_DIR media/
  - git add updates.json
  - git add media
  - git commit -m 'update json and media [skip ci]' || true
  - git push

after_script:
  - git checkout --force $TRAVIS_BRANCH
  - ./trigger-pietvanzoen-build

env:
  global:
  - secure: JAJF8FVqhN5/imdf5+lGDB2h26RGg5KdyJxvm8dLMG4vSpbYEbrDViC9S/rUfr1yM8aQlDb9iuYWXOzBuqL6FS5N9K0pYBL+veQMtmzDDPyzPpeYqBnVAk1+j860vBC+11dQzgiJx8CvC9gFPIBIhaVNBy2dRLXcPp7TyjqEodg3tXnCMSsATu4jQSAeiXND6dFQB66vxvVFgEWzm6L34O8SBPi6/UZtrB5Zs4YwJislVjIrmZLgtQ5/3GztbLiFgNSUj6IDXmAQOdxOm9aYlIKvH9HNN9YzOa/74J1LjgmVTtx5Dc43Zwk2p9sruHT0CaLp1fJ/DfKlcYz4U6ADifF9ytVjxTXHF909spbWrSna0K1qX3ntzyNgrRi8RHpHAKcdMIcwjaOszCB3swX5nsvhK9eNji4ZdZr3ry7F3ZVwAKFKnq2fFiBKJxXULW8Nc180iZ+LDGBHtZnIhwFaIZSsKLEkvknYmMNS5t4JWL6p82bBElTd2PiHVPHAcflBxzLUUX9wQkcCqodczCZe3rgDaU1mu32OrSupITWHQ88vAFHeXbBAhyY1Xs7SGRFb5z/yU4028obs8PBt1Aw1Pi2eMXMeqHNiagP9OzjRUXpQVSjPbU/XmV8Hq0kqf0JHQMGL5tYUFu9mxFeafE3703PZga6VVPv/mOZ7EPoZ15Q=
